{% extends 'base.html' %}

{% block title %}√Årbol de Problemas{% endblock %}

{% block head %}
<!-- jsTree CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold">√Årbol de Problemas</h1>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">‚Üê Volver al men√∫ principal</a>
  </div>

  <section class="mb-4">
    <h2>¬øQu√© es?</h2>
    <p>El √°rbol de problemas es una herramienta para identificar las causas y efectos de un problema central. Ayuda a tomar decisiones m√°s informadas en la planeaci√≥n.</p>
  </section>

  <section class="mb-5">
    <h2>Simulador interactivo</h2>
    <p>Haz clic derecho en cualquier nodo para agregar o eliminar nodos. Puedes exportar el √°rbol en formato JSON o PDF.</p>

    <div id="arbolProblemas" class="border rounded p-3 mb-3" style="min-height: 300px;"></div>

    <div>
      <button class="btn btn-success me-2" onclick="exportarArbol()">üì§ Exportar JSON</button>
      <button class="btn btn-primary ms-2" onclick="descargarArbol()">üíæ Descargar JSON</button>
      <button class="btn btn-info ms-2" onclick="descargarPDF()">üìÑ Descargar PDF</button>
      <button class="btn btn-danger ms-2" onclick="reiniciarArbol()">üîÅ Reiniciar √°rbol</button>
      <button class="btn btn-warning ms-2" onclick="guardarArbolProblemas()">üß† Guardar en navegador</button>

    </div>

    <pre id="jsonSalida" class="bg-light mt-4 p-3 border rounded d-none"></pre>
  </section>

  <hr class="my-5">

  <section class="mb-4">
    <h2>¬øQu√© es un √Årbol de Problemas y para qu√© se utiliza?</h2>
    <p>
      El √°rbol de problemas es una herramienta visual que ayuda a identificar, analizar y entender un problema central en su contexto.
      Est√° compuesto por tres partes principales:
    </p>
    <ul>
      <li><strong>Problema central:</strong> Situaci√≥n negativa que se desea cambiar. Se coloca en el tronco del √°rbol.</li>
      <li><strong>Causas:</strong> Factores que provocan el problema. Se ubican en las ra√≠ces del √°rbol.</li>
      <li><strong>Efectos:</strong> Consecuencias o impactos que el problema genera. Se sit√∫an en la copa del √°rbol.</li>
    </ul>
  </section>

  <section class="mb-4">
    <h2>¬øC√≥mo funciona?</h2>
    <p>
      Esta herramienta parte de un diagn√≥stico participativo o t√©cnico. Se formula el problema principal y luego se analiza
      ‚Äú¬øpor qu√© ocurre?‚Äù para identificar causas, y ‚Äú¬øqu√© sucede como resultado?‚Äù para determinar efectos.
      Esta organizaci√≥n permite visualizar las relaciones causales de manera clara y comprensible.
    </p>
  </section>

  <section class="mb-4">
    <h2>¬øC√≥mo ayuda en la planeaci√≥n municipal?</h2>
    <p>
      En la administraci√≥n p√∫blica municipal, el √°rbol de problemas permite:
    </p>
    <ul>
      <li>Focalizar los esfuerzos del gobierno local en causas reales y no solo en s√≠ntomas.</li>
      <li>Establecer prioridades en la asignaci√≥n de recursos.</li>
      <li>Dise√±ar proyectos y programas con base en evidencia y l√≥gica causal.</li>
      <li>Facilitar la elaboraci√≥n de marcos l√≥gicos, presupuestos basados en resultados (PbR), POA y pol√≠ticas p√∫blicas efectivas.</li>
    </ul>
  </section>

  <section class="mb-4">
    <h2>Consejo final</h2>
    <p>
      Recuerda que el objetivo no es casarse con una soluci√≥n, sino enamorarse del problema.
      Entenderlo a profundidad te permitir√° generar alternativas m√°s efectivas, sostenibles y adecuadas para tu comunidad.
    </p>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  let dataInicial = [
    {
      "id": "problema_central",
      "text": "Problema Central: Alta deserci√≥n escolar",
      "state": { "opened": true },
      "children": [
        { "id": "causas", "text": "Causas", "children": [] },
        { "id": "efectos", "text": "Efectos", "children": [] }
      ]
    }
  ];

  let arbolData = JSON.parse(JSON.stringify(dataInicial));

  function limpiarNodos(nodos) {
    return nodos.map(nodo => ({
      text: nodo.text,
      children: nodo.children ? limpiarNodos(nodo.children) : []
    }));
  }

    $(function () {
    $('#arbolProblemas').jstree({
      'core': {
        'check_callback': true,
        'data': arbolData
      },
      "plugins": ["contextmenu", "dnd", "types"],
      "contextmenu": {
        "items": function (node) {
          let tree = $("#arbolProblemas").jstree(true);
          return {
            "Agregar": {
              "label": "‚ûï Agregar Nodo",
              "action": function () {
                let nuevo = tree.create_node(node, { "text": "Nuevo nodo" });
                tree.edit(nuevo);
              }
            },
            "Editar": {
              "label": "‚úèÔ∏è Editar Nodo",
              "action": function () {
                tree.edit(node);
              }
            },
            "Eliminar": {
              "label": "üóë Eliminar Nodo",
              "_disabled": node.id === "problema_central" || node.id === "causas" || node.id === "efectos",
              "action": function () {
                tree.delete_node(node);
              }
            }
          };
        }
      }
    });
  });

  function exportarArbol() {
    const arbol = $('#arbolProblemas').jstree(true).get_json('#', { flat: false });
    const arbolLimpio = limpiarNodos(arbol);
    document.getElementById("jsonSalida").textContent = JSON.stringify(arbolLimpio, null, 2);
    document.getElementById("jsonSalida").classList.remove("d-none");
  }

  function descargarArbol() {
    const arbol = $('#arbolProblemas').jstree(true).get_json('#', { flat: false });
    const arbolLimpio = limpiarNodos(arbol);
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(arbolLimpio, null, 2));
    const downloadAnchor = document.createElement('a');
    downloadAnchor.setAttribute("href", dataStr);
    downloadAnchor.setAttribute("download", "arbol_problemas.json");
    document.body.appendChild(downloadAnchor);
    downloadAnchor.click();
    document.body.removeChild(downloadAnchor);
  }

  function descargarPDF() {
    html2canvas(document.querySelector("#arbolProblemas")).then(canvas => {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const imgData = canvas.toDataURL("image/png");
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, "PNG", 0, 10, pdfWidth, pdfHeight);
      pdf.save("arbol_problemas.pdf");
    });
  }

  function guardarArbolProblemas() {
    const arbol = $('#arbolProblemas').jstree(true).get_json('#', { flat: false });
    const arbolLimpio = limpiarNodos(arbol);
    localStorage.setItem('arbol_problemas', JSON.stringify(arbolLimpio));
    alert('√Årbol guardado en tu navegador (localStorage)');
  }

  function reiniciarArbol() {
    $('#arbolProblemas').jstree(true).settings.core.data = JSON.parse(JSON.stringify(dataInicial));
    $('#arbolProblemas').jstree(true).refresh();
    document.getElementById("jsonSalida").classList.add("d-none");
  }
</script>
{% endblock %}
